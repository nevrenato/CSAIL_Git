\documentclass{beamer}
\usetheme{Singapore}
\usecolortheme{default}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{verbatim}
\usepackage{graphics}
\usepackage{listings}
\usepackage{lmodern}

\title{Understanding Git with Alloy}
\subtitle{Milestone 2}
\author{Cláudio Lourenço \and Renato Neves}
\institute{University of Minho\\
Formal Methods in Software Engineering}


\logo{ \includegraphics[width=0.15\textwidth]{images/csail_logo.png}
       \includegraphics[width=0.15\textwidth]{images/uminho_eng_logo.png}}

\begin{document}

\frame {
   \titlepage
}

\frame{
   \frametitle{Table of contents}
   \tableofcontents 
}

\section{Where were we?}
\frame{
   \frametitle{Where were we?}
   \begin{columns}[c]
      \column{2.5in}
         \begin{itemize}
            \item Focusing on Index + Object Model
            \item No problem with add and rm operations
            \item Commit - Big Problem
         \end{itemize}
      \column{1.5in}
         \begin{figure}[t]
            \includegraphics[width=1.5in]{images/data_flow_simplified.png}
         \end{figure}
   \end{columns}
}

\frame{
   \frametitle{The problem}
   \begin{figure}
      \centering
      \includegraphics[width=0.9\textwidth]{images/structures.png}
   \end{figure}
}
\section{Progress}
\begin{frame}[fragile]
   \frametitle{How did we solve it?}
   \begin{block}{Abstraction}
      \begin{itemize}
         \item In each commit there is relation between Objects and Paths
         \item Facts to reflect the parent relationship
            \begin{itemize}
               \item The Tree pointed by the Commit corresponds to the root
               \item A contains relations exists, if and only if, the converse parent relation exists
            \end{itemize}
      \end{itemize}
   \end{block}
   \tiny
   \begin{lstlisting}[escapechar=!]
                        sig Commit extends Object {
                           points : Tree,
                           parent : set Commit,
                           !\color{red}{abs: Path -> Object}!
                        }
  \end{lstlisting}

\end{frame}

\frame{
   \frametitle{The abstraction relation}
   \begin{figure}
      \centering
      \includegraphics[width=0.3\textwidth]{images/abs1.png}
   \end{figure}

}

\frame{
   \frametitle{The abstraction relation}
   \begin{figure}
      \centering
      \includegraphics[width=0.8\textwidth]{images/abs2.png}
   \end{figure}

}

\section{Current Model}
\begin{frame}[fragile]
   \frametitle{Model}
   \tiny
   \begin{columns}[c]
      \column{1.5in}
         \begin{lstlisting}
abstract sig Object {
   objects: set State
}

sig Blob extends Object {}

sig Tree extends Object {
   contains : Name -> lone (Tree+Blob)
}

sig Commit extends Object {
   points : Tree,
   parent : set Commit,
   abs: Path -> Object
}

sig RootCommit extends Commit {}

sig Branch{
   marks: Commit one -> State,
   branches: set State,
   head: set State
}

lone sig Master extends Branch{}
                  
         \end{lstlisting}
      \column{1.5in}
      \color{blue}{
         \begin{lstlisting}
sig Path {
   pathparent : lone Path,
   name : Name
}

sig File{
   path: Path,
   blob: Blob,
   index: set State
}
         \end{lstlisting}
      }
   \end{columns}
\end{frame}


\section{The operations}
\begin{frame}[fragile]
   \frametitle{Operations - add and rm}
   \begin{block}{add}
      Add a file with the current content to the index
   \end{block}
   \tiny
   \begin{lstlisting}
...
index.s' = index.s + 
           f - ((f.path).~path -f)
...   
   \end{lstlisting}
   \normalsize
   \begin{block}{rm}
      Remove the file from index
   \end{block}
   \tiny
   \begin{lstlisting}
...
index.s' = index.s - f
...
   \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - add and rm}
   \begin{figure}
      \centering
      \includegraphics[width=0.4\textwidth]{images/add1.png}
   \end{figure}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - add and rm}
   \begin{figure}
      \centering
      \includegraphics[width=0.38\textwidth]{images/add2.png}
   \end{figure}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - commit}
   \begin{block}{commit}
      Creates a commit, from the index
   \end{block}
   \tiny
   \begin{lstlisting}
...
(head.s').(marks.s').parent = (head.s).(marks.s)
...
(index.s).path.*pathparent = (head.s').(marks.s').abs.univ
all f:index.s | f.path -> f.blob in (head.s').(marks.s').abs
...
   \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - commit}
   \begin{figure}
      \centering
      \includegraphics[width=0.5\textwidth]{images/commit1.png}
   \end{figure}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - commit}
   \begin{figure}
      \centering
      \includegraphics[width=0.5\textwidth]{images/commit2.png}
   \end{figure}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - branch}
   \begin{block}{branch}
      Creates a new branch pointing to the current one
   \end{block}
   \tiny
   \begin{lstlisting}
...
branches.s' = branches.s + b
marks.s' = marks.s + b -> (head.s).(marks.s)
...
   \end{lstlisting}
   \normalsize
   \begin{block}{branch -d}
      Removes a branch if it is not pointed by the head
   \end{block}
   \tiny
   \begin{lstlisting}
...
branches.s' = branches.s - b
marks.s' = marks.s - b -> Commit
...
   \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - branch}
   \begin{columns}[c]
      \column{1.5in}
      \begin{figure}
         \centering
         \includegraphics[width=0.75\textwidth]{images/branch1.png}
      \end{figure}
      \pause
      \column{1.5in}
      \begin{figure}
         \centering
         \includegraphics[width=0.90\textwidth]{images/branch2.png}
      \end{figure}
   \end{columns}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - checkout}
      Updates the head and the index to reflect a certain commit pointed by a
      branch
   \begin{block}{Problems}
      \begin{itemize}
         \item Difficult to understand the pre conditions
         \item There are no specifications
     \end{itemize}
   \end{block}
\end{frame}

\begin{frame}
   \begin{block}{Pre conditions found relatively to the index}
      \begin{itemize}
         \item Removed files are ignored
         \item Not modified files since last commit are ignored
         \item New files or Modified files:
            \begin{itemize}
               \item if file exists on destination commit then:
                  \begin{itemize}
                     \item the content is the same as in index, or
                     \item the content in the destination commit is the same as in the current commit
                  \end{itemize}
               \item if the files does not exists in the destination commit
                  \begin{itemize}
                     \item it also does not exist on the current commit
                  \end{itemize}
            \end{itemize}
      \end{itemize}
   \end{block}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - checkout}
      \begin{figure}
         \centering
         \includegraphics[width=0.50\textwidth]{images/checkout1.png}
      \end{figure}
\end{frame}

\begin{frame}[fragile]
   \frametitle{Operations - checkout}
      \begin{figure}
         \centering
         \includegraphics[width=0.50\textwidth]{images/checkout2.png}
      \end{figure}
\end{frame}

\section{The properties}
\begin{frame}[fragile]
   \frametitle{Properties}
   \begin{block}{Invariant preservation}
      All operations preserve the invariant
   \end{block}
   \vspace{0.1in}
all s,s':State | invariant[s] and operation[s,s',...] implies invariant[s'] \\
   \vspace{0.3in}
   \tiny
   \begin{lstlisting}
pred invariant[s:State]{   
   some Commit & objects.s <=> some marks.s && one head.s
   head.s in branches.s & (marks.s).Commit
   (objects.s - Commit) in (objects.s).points.*(contents.Name)
   all t : objects.s & Tree | t.contents.Name in objects.s
   all c:objects.s & Commit | c.points in objects.s and c.parent in objects.s
   marks.s in branches.s -> one objects.s
   all s:State, t : objects.s & Tree | some t.contains
}
   \end{lstlisting}

\end{frame}

\begin{frame}[fragile]
   \frametitle{Properties}
   \begin{block}{Idempotence}
      \begin{itemize}
         \item After doing an operation repeating repeating it does not change the state
         \item Add, commit and checkout are idempotent
      \end{itemize}
   \end{block}
   \tiny
   \begin{lstlisting}
all s0,s1,s2 : State | operation[s0,s1,...] and operation[s1,s2,...] 
                       implies dynamicRelations[s1] = dynamicRelations[s2]
   \end{lstlisting}
\end{frame}

\section{Future work}
\frame{
   \frametitle{Future work}
   \begin{itemize}
      \item Merge operation
      \item Document operations and properties
   \end{itemize}
}

\frame{
   \titlepage
}


\end{document}
